name: Deploy GardenLog MCP
on:
 push:
    branches:
      - main
    paths:
      - "src/GardenLog.Mcp/**"
 pull_request:
    branches:
      - main
    paths:
      - "src/GardenLog.Mcp/**"
 workflow_dispatch:

env:
  PROJECT_NAME_FOR_DOCKER: gardenlogmcpapi
  CONTAINER_APP_NAME: gardenlogmcpapi-containerapp
  DOCKER_FILE_PATH: src/GardenLog.Mcp/GardenLog.Mcp.Api/Dockerfile

jobs:
  setup:
    runs-on: ubuntu-latest

    outputs:
      registry-server: ${{steps.retrieve_secrets.outputs.registry-server}}

    steps:
    - uses: Azure/login@v1.6.1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    - id: retrieve_secrets
      name: Retrieve secret from KV
      uses: azure/CLI@v1
      with:
        inlineScript: |
          echo registry-server=$(az keyvault secret show --name "registry-server" --vault-name "gardenlogvault" --query "value" -o tsv) >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 9.0.x

    - name: Restore dependencies
      run: dotnet restore src/GardenLog.Mcp/GardenLog.Mcp.Api/GardenLog.Mcp.Api.csproj

    - name: Build
      run: dotnet build src/GardenLog.Mcp/GardenLog.Mcp.Api/GardenLog.Mcp.Api.csproj --no-restore

  register_image:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    needs: [setup, build]

    steps:
    - uses: Azure/login@v1.6.1
      with:
       creds: ${{ secrets.AZURE_CREDENTIALS }}
    - name: Retrieve Container Registry Creds
      uses: azure/CLI@v1
      with:
       inlineScript: |
           echo registry-username=$(az keyvault secret show --name "registry-username" --vault-name "gardenlogvault" --query "value" -o tsv) >> $GITHUB_ENV
           echo registry-password=$(az keyvault secret show --name "registry-password" --vault-name "gardenlogvault" --query "value" -o tsv) >> $GITHUB_ENV

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Log in to container registry
      uses: docker/login-action@v3
      with:
        registry: ${{needs.setup.outputs.registry-server}}.azurecr.io
        username: ${{env.registry-username}}
        password: ${{env.registry-password}}
    - name: Build and push container image to registry
      uses: docker/build-push-action@v5.1.0
      with:
        push: true
        tags: ${{needs.setup.outputs.registry-server}}.azurecr.io/${{ env.PROJECT_NAME_FOR_DOCKER }}:${{ github.sha }}
        file: ${{ env.DOCKER_FILE_PATH }}

  deploy:
   if: github.event_name != 'pull_request'
   runs-on: ubuntu-latest
   needs: [setup, register_image]

   steps:
    - name: Log in to Azure
      uses: azure/login@v1.6.1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Container App
      uses: azure/container-apps-deploy-action@v2
      with:
        containerAppName: ${{env.CONTAINER_APP_NAME}}
        resourceGroup: GardenLog_ResourceGroup
        imageToDeploy: ${{needs.setup.outputs.registry-server}}.azurecr.io/${{ env.PROJECT_NAME_FOR_DOCKER }}:${{ github.sha }}
        environmentVariables: "ASPNETCORE_ENVIRONMENT=Production"